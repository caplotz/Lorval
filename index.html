<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gouvernement de Lorval — Accueil</title>

  <!-- Supabase JS (cdn) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>

  <style>
    :root{
      --navy:#0b2b4a;
      --accent:#0b2b4a;
      --muted:#7a8997;
      font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
    }

    html,body{
      height:100%;
      margin:0;
      background: #ffffff;
      color:var(--navy);
      -webkit-font-smoothing:antialiased;
    }

    .center {
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .card {
      width:100%;
      max-width:920px;
      background: #fff;
      border-radius:14px;
      padding:32px;
      box-shadow: 0 10px 30px rgba(11,43,74,0.08);
      text-align:center;
    }

    h1 {
      margin:0;
      font-weight:700;
      letter-spacing: -0.02em;
      font-size:36px;
      color:var(--navy);
    }

    p.lead {
      color:var(--muted);
      margin:12px 0 28px 0;
    }

    .btn {
      display:inline-block;
      border-radius:10px;
      padding:12px 18px;
      background:var(--navy);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      margin:8px;
      box-shadow: 0 6px 18px rgba(11,43,74,0.12);
      transition: transform .22s cubic-bezier(.2,.9,.3,1), opacity .22s;
      cursor:pointer;
      border:none;
    }
    .btn.ghost{
      background:transparent;
      color:var(--navy);
      border:1px solid rgba(11,43,74,0.08);
    }
    .btn:active{ transform: translateY(2px); }

    /* containers that appear/disappear */
    .panel {
      opacity:0;
      transform: translateY(8px);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events:none;
    }
    .panel.show {
      opacity:1;
      transform: translateY(0px);
      pointer-events:auto;
    }

    /* Welcome text animation */
    .welcome {
      font-size:28px;
      font-weight:700;
      color:var(--navy);
      opacity:1;
      transition: opacity 1s ease;
    }
    .welcome.fade-out {
      opacity:0;
    }

    /* small link */
    .small {
      margin-top:18px;
      color:var(--accent);
      font-size:14px;
    }

    /* form styling */
    .form {
      max-width:520px;
      margin:0 auto;
      text-align:left;
    }
    .field {
      display:flex;
      flex-direction:column;
      margin-bottom:12px;
    }
    label { font-size:13px; margin-bottom:6px; color:var(--navy); }
    input[type="text"], input[type="email"], input[type="password"] {
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(11,43,74,0.08);
      font-size:14px;
      outline:none;
      box-shadow: 0 6px 18px rgba(11,43,74,0.03) inset;
    }

    .msg {
      margin-top:8px;
      font-size:13px;
      color:#b23;
    }

    footer {
      margin-top:18px;
      font-size:13px;
      color:var(--muted);
    }

    /* tiny responsive */
    @media (max-width:560px){
      h1 { font-size:26px; }
      .card { padding:20px; }
    }
  </style>
</head>
<body>
  <div class="center">
    <div class="card" role="main">
      <div id="welcomeBlock">
        <div class="welcome" id="welcomeText">Bienvenue à Lorval!</div>
        <p class="lead">Site officiel — Services & accès citoyens</p>
      </div>

      <!-- main identity choice -->
      <div id="identityPanel" class="panel">
        <button class="btn" id="btnResident">Je vis à Lorval</button>
        <button class="btn ghost" id="btnVisitor">Je ne vis pas à Lorval</button>
        <div class="small"><a id="peek" href="#" style="color:var(--navy);text-decoration:none;">Je veux juste regarder le site.</a></div>
      </div>

      <!-- resident roles -->
      <div id="rolePanel" class="panel">
        <div style="margin-bottom:16px;font-weight:600;">Tu es :</div>
        <div>
          <button class="btn" data-role="civil">Je suis un civil</button>
          <button class="btn ghost" data-role="police">Je suis un agent de la paix (Police)</button>
          <button class="btn ghost" data-role="business">Je suis une entreprise</button>
          <button class="btn ghost" data-role="gov">Je suis une autorité gouvernementale</button>
          <button class="btn ghost" data-role="admin">Je suis un administrateur du site</button>
        </div>
      </div>

      <!-- civil auth panel -->
      <div id="civilPanel" class="panel">
        <div style="margin-bottom:14px;font-weight:600;">Civil — Choisis</div>
        <div>
          <button class="btn" id="btnLogin">Se connecter</button>
          <button class="btn ghost" id="btnSignup">Se créer un compte</button>
        </div>
      </div>

      <!-- login form -->
      <div id="loginPanel" class="panel">
        <form id="loginForm" class="form" onsubmit="return false;">
          <div class="field"><label for="loginEmail">Email</label><input id="loginEmail" type="email" required /></div>
          <div class="field"><label for="loginPassword">Mot de passe</label><input id="loginPassword" type="password" required /></div>
          <div style="text-align:center;">
            <button class="btn" id="doLogin">Connexion</button>
            <button class="btn ghost" id="backFromLogin">Retour</button>
          </div>
          <div id="loginMsg" class="msg" aria-live="polite"></div>
        </form>
      </div>

      <!-- signup form -->
      <div id="signupPanel" class="panel">
        <form id="signupForm" class="form" onsubmit="return false;">
          <div class="field"><label for="signupEmail">Email</label><input id="signupEmail" type="email" required /></div>
          <div class="field"><label for="signupName">Nom complet</label><input id="signupName" type="text" required /></div>
          <div class="field"><label for="signupPseudo">Pseudo</label><input id="signupPseudo" type="text" required /></div>
          <div class="field"><label for="signupSSN">Code de sécurité sociale</label><input id="signupSSN" type="text" required placeholder="ex: 123-45-678" /></div>
          <div class="field"><label for="signupPassword">Mot de passe</label><input id="signupPassword" type="password" required /></div>
          <div style="text-align:center;">
            <button class="btn" id="doSignup">Créer le compte</button>
            <button class="btn ghost" id="backFromSignup">Retour</button>
          </div>
          <div id="signupMsg" class="msg" aria-live="polite"></div>
        </form>
      </div>

      <footer id="footerNote">© Gouvernement de Lorval</footer>
    </div>
  </div>

  <script type="module">
    // ---------- Supabase setup ----------
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    const supabaseUrl = 'https://rmxgjsvpmnganddmnpdm.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJteGdqc3ZwbW5nYW5kZG1ucGRtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDMwNTgsImV4cCI6MjA3MTIxOTA1OH0.8q1RGvHvu3pu6BZo1DT3texcMvXMLNCm6gpwsR8lpDQ'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // ---------- Local "valid SSN" DB included in HTML ----------
    // Remplace ces valeurs par celles légit (exemple)
    const validSSNs = [
      '123-45-678', '111-22-333', '999-88-777', '555-66-444'
    ]

    // ---------- Helpers ----------
    const $ = id => document.getElementById(id)
    const panels = {
      identity: $('identityPanel'),
      role: $('rolePanel'),
      civil: $('civilPanel'),
      login: $('loginPanel'),
      signup: $('signupPanel')
    }

    function showPanel(panelEl) {
      // hide all panels then show target
      Object.values(panels).forEach(p => p.classList.remove('show'))
      panelEl.classList.add('show')
      window.scrollTo({top:0,behavior:'smooth'})
    }

    // Welcome animation sequence
    const welcomeText = $('welcomeText')
    const identityPanel = $('identityPanel')
    setTimeout(()=> {
      // fade-out welcome then show identity
      welcomeText.classList.add('fade-out')
      setTimeout(()=> {
        $('welcomeBlock').style.display='none'
        showPanel(identityPanel)
      }, 900)
    }, 1100)

    // Event listeners
    $('btnResident').addEventListener('click', ()=> {
      // fade
      identityPanel.classList.remove('show')
      setTimeout(()=> showPanel(panels.role), 250)
    })

    // "just look" link
    $('peek').addEventListener('click', (e)=>{
      e.preventDefault()
      alert("Visionneuse publique activée. Navigation limitée. (Simulation)")
    })

    // role buttons
    document.querySelectorAll('[data-role]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const role = btn.dataset.role
        if(role === 'civil') {
          panels.role.classList.remove('show')
          setTimeout(()=> showPanel(panels.civil), 240)
        } else {
          alert("Section pour '" + btn.textContent + "' — pas implémentée dans cette démo.")
        }
      })
    })

    // civil panel actions
    $('btnLogin').addEventListener('click', ()=> {
      panels.civil.classList.remove('show')
      setTimeout(()=> showPanel(panels.login), 240)
    })
    $('btnSignup').addEventListener('click', ()=> {
      panels.civil.classList.remove('show')
      setTimeout(()=> showPanel(panels.signup), 240)
    })

    // back buttons
    $('backFromLogin').addEventListener('click', ()=> {
      panels.login.classList.remove('show')
      setTimeout(()=> showPanel(panels.civil), 240)
    })
    $('backFromSignup').addEventListener('click', ()=> {
      panels.signup.classList.remove('show')
      setTimeout(()=> showPanel(panels.civil), 240)
    })

    // ---------- Login logic ----------
    $('doLogin').addEventListener('click', async (e) => {
      e.preventDefault()
      $('loginMsg').textContent = ''
      const email = $('loginEmail').value.trim()
      const password = $('loginPassword').value
      if(!email || !password){ $('loginMsg').textContent = 'Remplis email & mot de passe.'; return; }

      $('doLogin').disabled = true
      $('doLogin').textContent = 'Connexion...'

      try {
        // utilise Supabase Auth
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })
        if(error) {
          console.error('Login error', error)
          $('loginMsg').textContent = 'Email ou mot de passe invalide.'
          $('doLogin').disabled = false
          $('doLogin').textContent = 'Connexion'
          return
        }
        // Login OK - redirige dashboard
        localStorage.setItem('lorval_user', JSON.stringify({ email }))
        window.location.href = 'dashboard.html'
      } catch(err) {
        console.error(err)
        $('loginMsg').textContent = 'Erreur inattendue.'
      } finally {
        $('doLogin').disabled = false
        $('doLogin').textContent = 'Connexion'
      }
    })

    // ---------- Signup logic ----------
    $('doSignup').addEventListener('click', async (e) => {
      e.preventDefault()
      $('signupMsg').textContent = ''
      const email = $('signupEmail').value.trim()
      const name = $('signupName').value.trim()
      const pseudo = $('signupPseudo').value.trim()
      const ssn = $('signupSSN').value.trim()
      const password = $('signupPassword').value

      // basic checks
      if(!email || !name || !pseudo || !ssn || !password) { $('signupMsg').textContent = 'Remplis tous les champs.'; return; }
      if(!validSSNs.includes(ssn)) { $('signupMsg').textContent = 'Code de sécurité sociale invalide.'; return; }

      $('doSignup').disabled = true
      $('doSignup').textContent = 'Création...'

      try {
        // 1) Check uniqueness from table 'citizens'
        // Note: assure-toi d'avoir une table 'citizens' dans Supabase avec colonnes email, pseudo, ssn
        // On fait trois queries pour la clarté (tu peux combiner en un seul call).
        const { data: byEmail } = await supabase.from('citizens').select('id').eq('email', email).limit(1)
        if(byEmail && byEmail.length) { $('signupMsg').textContent = 'Email déjà utilisé.'; throw 'dup' }

        const { data: byPseudo } = await supabase.from('citizens').select('id').eq('pseudo', pseudo).limit(1)
        if(byPseudo && byPseudo.length) { $('signupMsg').textContent = 'Pseudo déjà utilisé.'; throw 'dup' }

        const { data: bySSN } = await supabase.from('citizens').select('id').eq('ssn', ssn).limit(1)
        if(bySSN && bySSN.length) { $('signupMsg').textContent = 'Code de sécurité sociale déjà utilisé.'; throw 'dup' }

        // 2) Create auth user (supabase auth)
        const { data: signData, error: signError } = await supabase.auth.signUp({ email, password })
        if(signError) {
          console.error('Auth signup err', signError)
          $('signupMsg').textContent = 'Impossible de créer l’utilisateur (auth).'
          throw signError
        }
        // Optionnel : insert profile into citizens table
        const { data: insertData, error: insertError } = await supabase.from('citizens').insert([
          { email, full_name: name, pseudo, ssn }
        ])
        if(insertError){
          console.error('Insert profile err', insertError)
          $('signupMsg').textContent = 'Erreur lors de l’ajout du profil.'
          throw insertError
        }

        // succès
        localStorage.setItem('lorval_user', JSON.stringify({ email }))
        window.location.href = 'dashboard.html'
      } catch(err){
        if(err !== 'dup') console.error(err)
      } finally {
        $('doSignup').disabled = false
        $('doSignup').textContent = 'Créer le compte'
      }
    })

    // Bonus: check if already logged in
    (async ()=> {
      const { data: { user } } = await supabase.auth.getUser().catch(()=>({ data:{ user:null } }))
      if(user){
        localStorage.setItem('lorval_user', JSON.stringify({ email: user.email }))
        // redirect quietly
        // window.location.href = 'dashboard.html' // commented to not annoy during dev
      }
    })()

  </script>
</body>
</html>
